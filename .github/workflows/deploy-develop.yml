name: User Service Develop Branch CI/CD

on:
  push:
    branches:
      - feature/basic-user-mgmt-use-cases

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Disabling shallow clone is recommended for improving relevancy of reporting
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        with:
          projectBaseDir: src
          args: >
            -Dsonar.python.coverage.reportPaths=target/coverage.xml
            -Dsonar.sources=src/
            -Dsonar.test.exclusions=src/test/**
            -Dsonar.tests=src/test/
            -Dsonar.verbose=true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Build Docker image
        run: |
          docker build -t user-service .
          docker tag user-service:latest user-service:latest

      - name: Start LocalStack
        uses: LocalStack/setup-localstack@main
        with:
          image-tag: 'latest'
          install-awslocal: 'true'
          configuration: DEBUG=1

      - name: Run Docker Image
        run: |
          docker run -d --name user-service user-service:latest

      - name: Run Tests against LocalStack
        run: |
          # Create a security group
          awslocal ec2 create-security-group --group-name my-sg --description "My security group"
        
          # Launch an EC2 instance
          awslocal ec2 run-instances --image-id ami-0abcdef1234567890 --count 1 --instance-type t2.micro --key-name my-key-pair --security-groups my-sg
        
          # Describe the EC2 instance
          awslocal ec2 describe-instances